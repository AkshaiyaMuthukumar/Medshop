{% extends "base.html" %}
{% load static %}
{% block content %}

<!-- MAIN BANNER -->
<section class="main-banner text-white d-flex align-items-center mb-4">
  <div class="banner-section p-4 rounded w-100 text-center">
    <h2 class="fw-bold" style="color:rgb(7, 75, 69);">Welcome to MedShop</h2>
    <p style="color:rgb(7, 75, 69);">Order genuine medicines online at the best price, delivered to your doorstep.</p>
  </div>
</section>

<!-- FEATURED CAROUSEL -->
<div id="featuredCarousel" class="carousel slide mb-4" data-bs-ride="carousel">
  <div class="carousel-inner">
    <div class="carousel-item active">
      <img src="{% static 'images/featured1.jpg' %}" class="d-block w-100 rounded" alt="Featured 1">
    </div>
    <div class="carousel-item">
      <img src="{% static 'images/featured2.jpg' %}" class="d-block w-100 rounded" alt="Featured 2">
    </div>
    <div class="carousel-item">
      <img src="{% static 'images/featured3.jpg' %}" class="d-block w-100 rounded" alt="Featured 3">
    </div>
  </div>
  <button class="carousel-control-prev" type="button" data-bs-target="#featuredCarousel" data-bs-slide="prev">
    <span class="carousel-control-prev-icon"></span>
  </button>
  <button class="carousel-control-next" type="button" data-bs-target="#featuredCarousel" data-bs-slide="next">
    <span class="carousel-control-next-icon"></span>
  </button>
</div>

<!-- FEATURED MEDICINES -->
<section class="mt-5">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h4>Available Medicines</h4>
    <div>
      <a href="{% url 'medicines:all_medicines' %}" class="btn btn-success">More →</a>
    </div>
  </div>

  <div class="row">
    {% if medicines %}
      {% for med in medicines|slice:":8" %}
        <div class="col-md-6 col-lg-3 mb-4">
          <div class="medicine-card h-100 border rounded p-2 text-center shadow-sm">
            {% if med.image %}
              <img src="{{ med.image.url }}" alt="{{ med.name }}" class="img-fluid rounded mb-2">
            {% else %}
              <img src="{% static 'images/placeholder.png' %}" alt="No image" class="img-fluid rounded mb-2">
            {% endif %}
            <h6 class="mt-2">{{ med.name }}</h6>
            <p class="price">₹ {{ med.price }}</p>
            <div class="d-flex justify-content-center gap-2 mt-2">
              <a href="{% url 'medicines:medicine_detail' med.id %}" class="btn btn-primary btn-sm">View</a>
              {% if user.is_authenticated %}
                <button class="btn btn-success btn-sm add-cart-btn" data-id="{{ med.id }}">Add to Cart</button>
              {% else %}
                <a class="btn btn-secondary btn-sm" href="{% url 'users:login' %}">Login</a>
              {% endif %}
            </div>
          </div>
        </div>
      {% endfor %}
    {% else %}
      <p>No medicines available.</p>
    {% endif %}
  </div>
</section>

<!-- Toast -->
<div id="toast" style="
    position: fixed;
    top: 20px;
    right: 30px;
    background: #e8f5f1ff;
    color: #05c088;
    padding: 15px 20px;
    border-radius: 15px;
    display: none;
    z-index: 9999;
"></div>

<script>
document.addEventListener('DOMContentLoaded', function(){
    const buttons = document.querySelectorAll('.add-cart-btn');

    buttons.forEach(btn => {
        btn.addEventListener('click', function(){
            const medicineId = this.getAttribute('data-id');
            const button = this;

            fetch(`/orders/add-ajax/${medicineId}/`, {  // Ensure this matches urls.py
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(res => res.json())
            .then(data => {
                if(data.success){
                    // Change button text to "Added"
                    button.innerText = 'Added';
                    button.disabled = true;

                    // Show toast message
                    const toast = document.getElementById('toast');
                    toast.innerText = data.medicine_name + " added to cart!";
                    toast.style.display = 'block';
                    setTimeout(() => { toast.style.display = 'none'; }, 5000);

                    // Update cart count in navbar
                    const cartCount = document.getElementById('cart-count');
                    if(cartCount) cartCount.innerText = data.total_items;
                }
            })
            .catch(err => console.error(err));
        });
    });
});
</script>

{% endblock %}
